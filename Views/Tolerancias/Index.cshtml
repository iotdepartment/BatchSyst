@model IEnumerable<Batch.Models.Tolerancia>

@{
    ViewData["Title"] = "Listado de Tolerancias";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

<div class="container mt-3 bg-body px-5 pb-5 pt-4 rounded-4 shadow-sm">

    <div class="row mb-3 align-items-end">

        <div class="col-3">
            <div class="d-grid gap-2 ">
                <a asp-action="Create" class="btn btn-primary rounded-pill">Nueva Tolerancia <i class="bi bi-plus-circle"></i></a>
            </div>
        </div>

        <div class="col-3">
            <label for="filtroComponente" class="form-label fw-bold">Filtrar por componente:</label>
            <select id="filtroComponente" class="form-select rounded-pill">
                <option value="">Todos</option>
                @foreach (var comp in Model.Select(m => m.Componente?.Name).Distinct().Where(c => c != null))
                {
                    <option value="@comp">@comp</option>
                }
            </select>
        </div>

    </div>

    <table id="tablaTolerancias" class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Id</th>
                <th>Componente</th>
                <th>Prueba</th>
                <th>Max</th>
                <th>Min</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Id</td>
                    <td>@item.Componente?.Name</td>
                    <td>@item.Prueba</td>
                    <td>@item.Max</td>
                    <td>@item.Min</td>
                    <td>
                        <button class="btn btn-warning btn-sm btn-editar"
                                data-id="@item.Id"
                                data-componente="@item.ComponenteId"
                                data-prueba="@item.Prueba"
                                data-max="@item.Max"
                                data-min="@item.Min">
                            Editar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

</div>

<!-- ✅ Modal fuera del container -->
@await Html.PartialAsync("_EditarToleranciaModal", Model)

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {

            var table = $('#tablaTolerancias').DataTable({
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-MX.json"
                },
                pageLength: 10,
                responsive: true,
                ordering: true,
                columnDefs: [
                    { orderable: false, targets: [5] }
                ]
            });

            $('#filtroComponente').on('change', function () {
                var valor = $(this).val();
                table.column(1).search(valor).draw();
            });

        });
    </script>

    <script>
        // ✅ Abrir modal y cargar datos
        $(document).on("click", ".btn-editar", function () {

            $("#edit-id").val($(this).data("id"));
            $("#edit-componente").val($(this).data("componente"));
            $("#edit-prueba").val($(this).data("prueba"));
            $("#edit-max").val($(this).data("max"));
            $("#edit-min").val($(this).data("min"));

            var modal = new bootstrap.Modal(document.getElementById("modalEditarTolerancia"));
            modal.show();
        });

        // ✅ Guardar por AJAX y actualizar fila sin recargar
        $(document).on("submit", "#formEditarTolerancia", function (e) {
            e.preventDefault();

            const data = {
                Id: $("#edit-id").val(),
                ComponenteId: $("#edit-componente").val(),
                Prueba: $("#edit-prueba").val(),
                Max: $("#edit-max").val(),
                Min: $("#edit-min").val()
            };

            $.ajax({
                url: "/Tolerancias/EditarAjax",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (resp) {
                    if (resp.success) {

                        let row = $("#tablaTolerancias")
                            .DataTable()
                            .row($(`button[data-id='${resp.id}']`).closest("tr"));

                        row.data([
                            resp.id,
                            resp.componente,
                            resp.prueba,
                            resp.max,
                            resp.min,
                            row.data()[5]
                        ]).draw(false);

                        bootstrap.Modal.getInstance(document.getElementById("modalEditarTolerancia")).hide();
                    }
                }
            });
        });
    </script>
}