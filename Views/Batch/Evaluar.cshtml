@model Batch.Models.Lote

<h2 class="text-2xl font-bold mb-4">Evaluación del Lote @Model.Folio</h2>

<form id="formResultados" asp-action="GuardarResultados" method="post">
    <input type="hidden" name="loteId" value="@Model.Id" />

    <table class="min-w-full border border-gray-300 rounded-lg shadow-sm">
        <thead class="bg-gray-100">
            <tr>
                <th class="px-4 py-2 text-left">Prueba</th>
                <th class="px-4 py-2 text-left">Min</th>
                <th class="px-4 py-2 text-left">Max</th>
                <th class="px-4 py-2 text-left">Valor</th>
                <th class="px-4 py-2 text-left">Estado</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Resultados.Count; i++)
            {
                var resultado = Model.Resultados.ElementAt(i);
                <tr class="border-t">
                    <td class="px-4 py-2">@resultado.Tolerancia.Prueba</td>
                    <td class="px-4 py-2">@resultado.Tolerancia.Min</td>
                    <td class="px-4 py-2">@resultado.Tolerancia.Max</td>
                    <td class="px-4 py-2">
                        <input type="hidden" name="resultados[@i].ResultadoId" value="@resultado.Id" />
                        <input type="number" step="0.01"
                               name="resultados[@i].Valor"
                               id="valor-@resultado.Id"
                               value="@(resultado.Valor.HasValue? resultado.Valor.ToString() : "")"
                               class="w-24 px-2 py-1 border rounded-md text-center focus:ring focus:ring-blue-300"
                               @(Model.Estado != EstadoBatch.PendienteDeLlenado ? "disabled" : "")
                               onblur="evaluarLocal(@resultado.Id, @resultado.Tolerancia.Min, @resultado.Tolerancia.Max)" />
                    </td>
                    <td id="estado-@resultado.Id" class="px-4 py-2">
                        @if (resultado.Valor.HasValue)
                        {
                    @Html.Raw(resultado.EsValido
                                        ? "<span class='inline-block px-2 py-1 text-xs font-semibold text-white bg-green-500 rounded'>OK</span>"
                                        : "<span class='inline-block px-2 py-1 text-xs font-semibold text-white bg-red-500 rounded'>FAIL</span>")
                                        }
                </td>
            </tr>
                        }
        </tbody>
    </table>

    @if (Model.Estado == EstadoBatch.PendienteDeLlenado)
    {
        <button type="button"
                class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                data-bs-toggle="modal" data-bs-target="#confirmModal">
            Guardar Resultados
        </button>
    }
    else
    {
        <div class="mt-4 p-4 bg-blue-100 border border-blue-300 rounded">
            Estado del lote: <strong>@Model.Estado</strong><br />
            Fecha cambio de estado: <strong>@Model.FechaCambioEstado?.ToString("dd/MM/yyyy HH:mm")</strong>
        </div>
    }
</form>

<!-- Modal de verificación -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-white rounded-lg shadow-lg">
            <div class="modal-header flex justify-between items-center p-4 border-b">
                <h5 class="text-lg font-semibold">Confirmar Guardado</h5>
                <button type="button" class="text-gray-500 hover:text-gray-700" data-bs-dismiss="modal">✕</button>
            </div>
            <div class="modal-body p-4" id="resumenModal">
                <!-- Aquí se llenará con JS el resumen -->
            </div>
            <div class="modal-footer flex justify-end gap-2 p-4 border-t">
                <button type="submit"
                        form="formResultados"
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                        id="btnConfirmar" disabled>
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function evaluarLocal(resultadoId, min, max) {
            const valor = parseFloat(document.getElementById(`valor-${resultadoId}`).value);
            if (isNaN(valor)) return;

            const estadoCell = document.getElementById(`estado-${resultadoId}`);
            if (valor >= min && valor <= max) {
                estadoCell.innerHTML = "<span class='inline-block px-2 py-1 text-xs font-semibold text-white bg-green-500 rounded'>OK</span>";
            } else {
                estadoCell.innerHTML = "<span class='inline-block px-2 py-1 text-xs font-semibold text-white bg-red-500 rounded'>FAIL</span>";
            }
        }

        // Antes de abrir el modal, genera resumen
        document.getElementById("confirmModal").addEventListener("show.bs.modal", () => {
            const inputs = document.querySelectorAll("input[type=number]");
            let llenadas = 0, ok = 0, fail = 0;

            inputs.forEach(i => {
                if (i.value) llenadas++;
            });

            document.querySelectorAll("td[id^=estado-]").forEach(td => {
                if (td.innerText.includes("OK")) ok++;
                if (td.innerText.includes("FAIL")) fail++;
            });

            const resumen = `
                <p>Total pruebas: ${inputs.length}</p>
                <p>Llenadas: ${llenadas}</p>
                <p>OK: ${ok}</p>
                <p>FAIL: ${fail}</p>
            `;

            document.getElementById("resumenModal").innerHTML = resumen;

            // habilitar confirmación solo si todas llenadas
            document.getElementById("btnConfirmar").disabled = (llenadas !== inputs.length);
        });
    </script>
}