@model Batch.Models.Lote

<h2>Evaluación del Lote @Model.Folio</h2>

<form id="formResultados" asp-action="GuardarResultados" method="post">
    <input type="hidden" name="loteId" value="@Model.Id" />

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Prueba</th>
                <th>Min</th>
                <th>Max</th>
                <th>Valor</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Resultados.Count; i++)
            {
                var resultado = Model.Resultados.ElementAt(i);
                <tr>
                    <td>@resultado.Tolerancia.Prueba</td>
                    <td>@resultado.Tolerancia.Min</td>
                    <td>@resultado.Tolerancia.Max</td>
                    <td>
                        <input type="hidden" name="resultados[@i].ResultadoId" value="@resultado.Id" />
                        <input type="number" step="0.01"
                               name="resultados[@i].Valor"
                               id="valor-@resultado.Id"
                               value="@(resultado.Valor.HasValue? resultado.Valor.ToString() : "")"
                               class="form-control"
                               @(Model.Estado != EstadoBatch.PendienteDeLlenado ? "disabled" : "")
                               onblur="evaluarLocal(@resultado.Id, @resultado.Tolerancia.Min, @resultado.Tolerancia.Max)" />
                    </td>
                    <td id="estado-@resultado.Id">
                        @if (resultado.Valor.HasValue)
                        {
                    @Html.Raw(resultado.EsValido
                                        ? "<span class='badge bg-success'>OK</span>"
                                        : "<span class='badge bg-danger'>FAIL</span>")
                                        }
                </td>
            </tr>
                        }
        </tbody>
    </table>

    @if (Model.Estado == EstadoBatch.PendienteDeLlenado)
    {
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
            Guardar Resultados
        </button>
    }
    else
    {
        <div class="alert alert-info mt-3">
            Estado del lote: <strong>@Model.Estado</strong><br />
            Fecha cambio de estado: <strong>@Model.FechaCambioEstado?.ToString("dd/MM/yyyy HH:mm")</strong>
        </div>
    }
</form>

<!-- Modal de verificación -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Guardado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resumenModal">
                <!-- Aquí se llenará con JS el resumen -->
            </div>
            <div class="modal-footer">
                <button type="submit" form="formResultados" class="btn btn-success" id="btnConfirmar" disabled>Confirmar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function evaluarLocal(resultadoId, min, max) {
            const valor = parseFloat(document.getElementById(`valor-${resultadoId}`).value);
            if (isNaN(valor)) return;

            const estadoCell = document.getElementById(`estado-${resultadoId}`);
            if (valor >= min && valor <= max) {
                estadoCell.innerHTML = "<span class='badge bg-success'>OK</span>";
            } else {
                estadoCell.innerHTML = "<span class='badge bg-danger'>FAIL</span>";
            }
        }

        // Antes de abrir el modal, genera resumen
        document.getElementById("confirmModal").addEventListener("show.bs.modal", () => {
            const inputs = document.querySelectorAll("input[type=number]");
            let llenadas = 0, ok = 0, fail = 0;

            inputs.forEach(i => {
                if (i.value) llenadas++;
            });

            document.querySelectorAll("td[id^=estado-]").forEach(td => {
                if (td.innerText.includes("OK")) ok++;
                if (td.innerText.includes("FAIL")) fail++;
            });

            const resumen = `
                <p>Total pruebas: ${inputs.length}</p>
                <p>Llenadas: ${llenadas}</p>
                <p>OK: ${ok}</p>
                <p>FAIL: ${fail}</p>
            `;

            document.getElementById("resumenModal").innerHTML = resumen;

            // habilitar confirmación solo si todas llenadas
            document.getElementById("btnConfirmar").disabled = (llenadas !== inputs.length);
        });
    </script>
}