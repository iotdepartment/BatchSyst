@model IEnumerable<Batch.Models.Lote>
@using Batch.ViewModels
@{
    ViewData["Title"] = "Batches";
}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

<div class="container mt-5">
    <!-- Botón para abrir modal -->
    <div class="row mb-4">
        <div class="col d-flex justify-content-start">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoBatchModal">
                Nuevo Batch
            </button>
        </div>
    </div>

    <h3 class="mb-3">Listado de Batches</h3>
    <div id="alertas"></div>
    <table id="tablaLotes" class="table table-striped table-bordered">
        <thead class="table-dark text-center">
            <tr>
                <th>Folio</th>
                <th>Componente</th>
                <th>Turno</th>
                <th>Fecha de creación</th>
                <th>Acción</th>
                <th>Estado / Pruebas pendientes</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    var pruebasPendientes = item.Resultados?
                    .Where(r => r.Valor == null)
                    .Select(r => r.Tolerancia?.Prueba)
                    .ToList();

                    <tr>
                        <td class="text-center">@item.Folio</td>
                        <td class="text-center">@(item.Componente?.Name ?? "Sin componente")</td>
                        <td class="text-center">@Batch.Helpers.DiaLaboralHelper.ObtenerTurno(item.FechaInicio)</td>
                        <td class="text-center">@item.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                        <td class="text-center">
                            @if (item.Estado == EstadoBatch.PendienteDeLlenado)
                            {
                                <button class="btn btn-sm btn-info rounded-pill" type="button"
                                        data-bs-toggle="modal" data-bs-target="#evaluarModal-@item.Id">
                                    Evaluar
                                </button>
                            }
                            else if (item.Estado == EstadoBatch.LlenadoAprobado)
                            {
                                <button class="btn btn-sm btn-primary rounded-pill" type="button"
                                        data-bs-toggle="modal" data-bs-target="#rfidModal-@item.Id">
                                    Ingresar RFID
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-secondary rounded-pill" type="button" disabled>
                                    Evaluar
                                </button>
                            }
                        </td>
                        <td class="text-center">
                            @if (pruebasPendientes != null && pruebasPendientes.Any())
                            {
                                <!-- Caso 1: hay pruebas sin llenar -->
                                <div class="d-flex flex-wrap justify-content-center gap-2">
                                    @foreach (var prueba in pruebasPendientes)
                                    {
                                        <span class="badge bg-warning text-white">@prueba</span>
                                    }
                                </div>
                            }
                            else if (item.Estado != EstadoBatch.LlenadoAprobado)
                            {
                                <!-- Caso 2: todas llenas pero aún no enviado/aprobado -->
                                <span class="badge bg-info text-white">Pendiente de envío</span>
                            }
                            else
                            {
                                <!-- Caso 3: aprobado -->
                                <span class="badge bg-success">Aprobado</span>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center text-muted">No hay lotes disponibles</td>
                </tr>
            }
        </tbody>
    </table>
</div>



@foreach (var lote in Model.Where(l => l.Estado == EstadoBatch.PendienteDeLlenado))
{
    @await Html.PartialAsync("_EvaluarBatchModal", lote)
}

@foreach (var item in Model.Where(l => l.Estado == EstadoBatch.LlenadoAprobado))
{
    @await Html.PartialAsync("_AsignarRfidModal", item)
}

@await Html.PartialAsync("_ConfirmarEnvioModal")

<!-- Render del partial del modal -->
@await Html.PartialAsync("_NuevoBatchModal", (NuevoBatchModalViewModel)ViewBag.ModalVm)

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>


    <script>
         $(document).ready(function () {
            $('#tablaLotes').DataTable({
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-MX.json"
                },
                pageLength: 10,
                responsive: true,
                ordering: true,
                columnDefs: [
                    { orderable: false, targets: [4, 5] } // ⚡ evita ordenar columnas de acción y estado
                ]
            });
        });


        document.addEventListener("DOMContentLoaded", function () {
            // Selecciona todos los modales de RFID
            document.querySelectorAll('[id^="rfidModal-"]').forEach(modalEl => {
                modalEl.addEventListener('shown.bs.modal', function () {
                    const input = modalEl.querySelector('input[id^="rfidInput-"]');
                    if (input) {
                        input.focus();
                    }
                });
            });
        });


        // Guardar resultados desde modal de evaluación
        function guardarResultados(loteId, enviar) {
            const scope = document.querySelector(`#evaluarModal-${loteId}`);
            if (!scope) {
                alert("No se encontró el modal de evaluación para el lote " + loteId);
                return;
            }

            const inputs = scope.querySelectorAll('input[id^="valor-"]');
            const resultados = [];

            inputs.forEach(i => {
                resultados.push({
                    ResultadoId: i.id.replace("valor-", ""),
                    Valor: i.value === "" ? null : parseFloat(i.value)
                });
            });

            fetch('/Batch/GuardarResultados', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ loteId: loteId, resultados: resultados, enviar: enviar })
            })
            .then(r => {
                if (r.ok) {
                    // ⚡ Forzar instancia y ocultar modal
                    const modalEl = document.getElementById(`evaluarModal-${loteId}`);
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.hide();

                    mostrarAlerta("Datos guardados correctamente", "success");
                    setTimeout(() => location.reload(), 1200);
                } else {
                    mostrarAlerta("Error al guardar resultados", "danger");
                }
            })
            .catch(() => mostrarAlerta("Error de red al guardar resultados", "danger"));
        }

        function guardarRFID(loteId) {
            const input = document.getElementById(`rfidInput-${loteId}`);
            if (!input) {
                mostrarAlerta("No se encontró el campo RFID", "danger");
                return;
            }

            const rfid = input.value.trim();
            if (rfid === "") {
                mostrarAlerta("Debes ingresar un RFID válido", "warning");
                return;
            }

            fetch('/Batch/GuardarRFID', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ LoteId: loteId, RFID: rfid })
            })
            .then(r => {
                if (r.ok) {
                    return r.json();
                } else {
                    throw new Error("Error al asignar RFID");
                }
            })
            .then(data => {
                // ⚡ Cierra el modal
                const modalEl = document.getElementById(`rfidModal-${loteId}`);
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();

                // ⚡ Actualiza la celda de acción en la tabla
                const fila = document.querySelector(`#tablaLotes tr td button[data-bs-target="#rfidModal-${loteId}"]`);
                if (fila) {
                    fila.outerHTML = `<span class="badge bg-info text-dark">RFID asignado</span>`;
                }

                mostrarAlerta("RFID asignado correctamente", "success");
            })
            .catch(err => {
                mostrarAlerta(err.message, "danger");
            });
        }

        // Confirmación de envío
        let lotePendienteEnvio = null;

        function confirmarEnvio(loteId) {
            lotePendienteEnvio = loteId;

            // ⚡ Cierra el modal de evaluación antes de abrir confirmación
            const evalModalEl = document.getElementById(`evaluarModal-${loteId}`);
            const evalModal = bootstrap.Modal.getInstance(evalModalEl);
            if (evalModal) evalModal.hide();

            const confirmModalEl = document.getElementById('confirmarEnvioModal');
            const confirmModal = bootstrap.Modal.getInstance(confirmModalEl) || new bootstrap.Modal(confirmModalEl);
            confirmModal.show();
        }

                document.addEventListener("DOMContentLoaded", function () {
            const btnConfirmarEnvio = document.getElementById("btnConfirmarEnvio");
            if (btnConfirmarEnvio) {
                btnConfirmarEnvio.addEventListener("click", function () {
                    if (lotePendienteEnvio) {
                        guardarResultados(lotePendienteEnvio, true);

                        // ⚡ Cierra el modal de confirmación
                        const confirmModalEl = document.getElementById('confirmarEnvioModal');
                        const confirmModal = bootstrap.Modal.getInstance(confirmModalEl) || new bootstrap.Modal(confirmModalEl);
                        confirmModal.hide();
                    }
                });
            }
        });

        // Pad numérico
        let currentInput = null;
        let currentMin = 0;
        let currentMax = 0;

        function abrirPad(resultadoId, min, max) {
            currentInput = document.getElementById(`valor-${resultadoId}`);
            currentMin = min;
            currentMax = max;
        }

        function padInput(loteId, num) {
            if (currentInput) {
                currentInput.value += num;
                validar(currentInput, currentMin, currentMax);
            }
        }

        function padDelete(loteId) {
            if (currentInput) {
                currentInput.value = currentInput.value.slice(0, -1);
                validar(currentInput, currentMin, currentMax);
            }
        }

        function validar(input, min, max) {
            const valor = parseFloat(input.value);
            const estadoCell = document.getElementById(`estado-${input.id.replace("valor-", "")}`);
            if (!isNaN(valor)) {
                estadoCell.innerHTML = (valor >= min && valor <= max)
                    ? "<span class='badge bg-success rounded-pill px-3'>OK</span>"
                    : "<span class='badge bg-danger rounded-pill px-3'>FAIL</span>";
            } else {
                estadoCell.innerHTML = "";
            }
        }

        // Alertas
        function mostrarAlerta(mensaje, tipo) {
            const contenedor = document.getElementById("alertas");
            if (!contenedor) return;
            contenedor.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    </script>
}