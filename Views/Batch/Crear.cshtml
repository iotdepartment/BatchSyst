@model IEnumerable<Batch.Models.Lote>
@using Batch.ViewModels

@{
    ViewData["Title"] = "Batches";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

@*<div class="container mt-3 bg-body px-5 pb-5 pt-4 rounded-4 shadow-sm">*@

    <div class="row mb-3 align-items-end">

        <div class="col-3">
            <div class="d-grid gap-2 ">
            <button class="btn btn-lg btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#nuevoBatchModal">
                    Nuevo Batch <i class="bi bi-plus-circle"></i>
            </button>
            </div>
        </div>

        <div class="col-3">
            <!-- Filtro por componente -->
            <label for="filtroComponente" class="form-label fw-bold">Filtrar por componente:</label>
            <select id="filtroComponente" class="form-select rounded-pill">
                <option value="">Todos</option>
                @foreach (var comp in Model.Select(m => m.Componente?.Name).Distinct().Where(c => c != null))
                {
                    <option value="@comp">@comp</option>
                }
            </select>
        </div>

    </div>

    <div id="tabla-lotes-container">
        @Html.Partial("_TablaLotes", Model)
    </div>

@*</div>*@

@foreach (var lote in Model.Where(l => l.Estado == EstadoBatch.PendienteDeLlenado))
{
    @await Html.PartialAsync("_EvaluarBatchModal", lote)
}

@foreach (var item in Model.Where(l => l.Estado == EstadoBatch.LlenadoAprobado))
{
    @await Html.PartialAsync("_AsignarRfidModal", item)
}

@await Html.PartialAsync("_ConfirmarEnvioModal")

@await Html.PartialAsync("_NuevoBatchModal", (NuevoBatchModalViewModel)ViewBag.ModalVm)

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {
             var table = $('#tablaLotes').DataTable({
                 language: {
                     url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-MX.json"
                 },
                   pageLength: 10,
                order: [0, "desc"], // ⚡ ordena por fecha creación descendente
                 responsive: true,
                 ordering: true,
                 columnDefs: [
                     { orderable: false, targets: [4, 5] } // ⚡ evita ordenar columnas de acción y estado
                 ]
             });

             // Filtro por componente
             $('#filtroComponente').on('change', function () {
                 var valor = $(this).val();
                 table.column(1).search(valor).draw(); // columna 1 = Componente
             });
         });

        document.addEventListener("DOMContentLoaded", function () {
            // Selecciona todos los modales de RFID
            document.querySelectorAll('[id^="rfidModal-"]').forEach(modalEl => {
                modalEl.addEventListener('shown.bs.modal', function () {
                    const input = modalEl.querySelector('input[id^="rfidInput-"]');
                    if (input) {
                        input.focus();
                    }
                });
            });
        });

        function guardarResultados(loteId, enviar) {
            const scope = document.querySelector(`#evaluarModal-${loteId}`);
            if (!scope) {
                mostrarToast("No se encontró el modal de evaluación", "danger");
                return;
            }

            const inputs = scope.querySelectorAll('input[id^="valor-"]');
            const resultados = [];

            inputs.forEach(i => {
                resultados.push({
                    ResultadoId: i.id.replace("valor-", ""),
                    Valor: i.value === "" ? null : parseFloat(i.value)
                });
            });

            fetch('/Batch/GuardarResultados', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ loteId: loteId, resultados: resultados, enviar: enviar })
            })
            .then(async r => {

                let data = null;
                try {
                    data = await r.json();
                } catch {
                    mostrarToast("Respuesta inválida del servidor", "danger");
                    return;
                }

                if (!r.ok || !data.success) {
                    mostrarToast(data?.mensaje || "Error al guardar resultados", "danger");
                    return;
                }

                // ✅ Cerrar modal
                const modalEl = document.getElementById(`evaluarModal-${loteId}`);
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.hide();

                // ✅ Guardar mensaje para mostrarlo DESPUÉS del refresh
                localStorage.setItem("toastSuccess", data.mensaje);

                // ✅ Refrescar página
                location.reload();
            })
            .catch(() => mostrarToast("Error de red al guardar resultados", "danger"));
        }

                function guardarRFID(loteId) {
            const input = document.getElementById(`rfidInput-${loteId}`);
            if (!input) {
                mostrarAlerta("No se encontró el campo RFID", "danger");
                return;
            }

            const rfid = input.value.trim();
            if (rfid === "") {
                mostrarAlerta("Debes ingresar un RFID válido", "warning");
                return;
            }

            fetch('/Batch/GuardarRFID', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ LoteId: loteId, RFID: rfid })
            })
            .then(r => {
                if (r.ok) {
                    return r.json();
                } else {
                    throw new Error("Error al asignar RFID");
                }
            })
            .then(data => {

                // ✅ Guardar mensaje en localStorage para mostrarlo después del reload
                localStorage.setItem("toastMessage", "RFID asignado correctamente");
                localStorage.setItem("toastType", "success");

                // ✅ Cerrar modal
                const modalEl = document.getElementById(`rfidModal-${loteId}`);
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();

                // ✅ Recargar página para actualizar tabla
                location.reload();
            })
            .catch(err => {
                mostrarAlerta(err.message, "danger");
            });
        }

        // Confirmación de envío
        let lotePendienteEnvio = null;

        function confirmarEnvio(loteId) {
            lotePendienteEnvio = loteId;

            // ⚡ Cierra el modal de evaluación antes de abrir confirmación
            const evalModalEl = document.getElementById(`evaluarModal-${loteId}`);
            const evalModal = bootstrap.Modal.getInstance(evalModalEl);
            if (evalModal) evalModal.hide();

            const confirmModalEl = document.getElementById('confirmarEnvioModal');
            const confirmModal = bootstrap.Modal.getInstance(confirmModalEl) || new bootstrap.Modal(confirmModalEl);
            confirmModal.show();
        }

        document.addEventListener("DOMContentLoaded", function () {
            const btnConfirmarEnvio = document.getElementById("btnConfirmarEnvio");
            if (btnConfirmarEnvio) {
                btnConfirmarEnvio.addEventListener("click", function () {
                    if (lotePendienteEnvio) {
                        guardarResultados(lotePendienteEnvio, true);

                        // ⚡ Cierra el modal de confirmación
                        const confirmModalEl = document.getElementById('confirmarEnvioModal');
                        const confirmModal = bootstrap.Modal.getInstance(confirmModalEl) || new bootstrap.Modal(confirmModalEl);
                        confirmModal.hide();
                    }
                });
            }
        });

        function validar(input, min, max) {
            const valor = parseFloat(input.value);
            const estadoCell = document.getElementById(`estado-${input.id.replace("valor-", "")}`);
            if (!isNaN(valor)) {
                estadoCell.innerHTML = (valor >= min && valor <= max)
                    ? "<span class='badge bg-success rounded-pill px-3'>OK</span>"
                    : "<span class='badge bg-danger rounded-pill px-3'>FAIL</span>";
            } else {
                estadoCell.innerHTML = "";
            }
        }

        function mostrarToast(mensaje, tipo = "success") {
            const toastContainer = document.getElementById("toastContainer");

            const toastId = "toast-" + Date.now();

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${tipo} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${mensaje}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML("beforeend", toastHtml);

            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    </script>
    <script>
               // ✅ Mostrar toast enviado desde el login
        document.addEventListener("DOMContentLoaded", function () {

            const msg = localStorage.getItem("toastMessage");
            const type = localStorage.getItem("toastType");

            if (msg) {
                mostrarToast(msg, type || "success");

                // ✅ Limpiar para que no se repita
                localStorage.removeItem("toastMessage");
                localStorage.removeItem("toastType");
            }
        });
    </script>
    <script>
         // Pad numérico
        let currentInput = null;
        let currentMin = 0;
        let currentMax = 0;

        function abrirPad(resultadoId, min, max) {
            currentInput = document.getElementById(`valor-${resultadoId}`);
            currentMin = min;
            currentMax = max;
        }

        function padInput(loteId, num) {
            if (currentInput) {
                currentInput.value += num;
                validar(currentInput, currentMin, currentMax);
            }
        }

        function padDelete(loteId) {
            if (currentInput) {
                currentInput.value = currentInput.value.slice(0, -1);
                validar(currentInput, currentMin, currentMax);
            }
        }
    </script>
}