@model IEnumerable<Lote>

<table id="tablaLotes" class="table table-striped table-bordered">
    <thead class="table-dark text-center">
        <tr>
            <th>Folio</th>
            <th>Componente</th>
            <th>Turno</th>
            <th>Fecha de creación</th>
            <th>Acción</th>
            <th>Estado / Pruebas pendientes</th>
        </tr>
    </thead>

    <tbody>
        @if (Model != null && Model.Any())
        {
            foreach (var item in Model)
            {
                var pruebasPendientes = item.Resultados?
                .Where(r => r.Valor == null)
                .Select(r => r.Tolerancia?.Prueba)
                .ToList();

                <tr>
                    <td class="text-center">@item.Folio</td>
                    <td class="text-center">@item.Componente?.Name</td>

                    <!-- ✅ Turno con badge -->
                    <td class="text-center">
                        @switch (item.Turno)
                        {
                            case 1:
                                @:<span class="badge bg-success rounded-pill px-3 py-2">Turno 1</span>
                                break;

                            case 2:
                                @:<span class="badge bg-primary rounded-pill px-3 py-2">Turno 2</span>
                                break;

                            case 3:
                                @:<span class="badge bg-warning text-dark rounded-pill px-3 py-2">Turno 3</span>
                                break;

                            default:
                                @:<span class="badge bg-secondary rounded-pill px-3 py-2">Desconocido</span>
                                break;
                        }
                    </td>

                    <td class="text-center">@item.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>

                    <td class="text-center">
                        @if (item.Estado == EstadoBatch.PendienteDeLlenado)
                        {
                            <button class="btn btn-sm btn-info rounded-pill"
                                    data-bs-toggle="modal"
                                    data-bs-target="#evaluarModal-@item.Id">
                                Evaluar
                            </button>
                        }
                        else if (item.Estado == EstadoBatch.LlenadoAprobado)
                        {
                            <button class="btn btn-sm btn-primary rounded-pill"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rfidModal-@item.Id">
                                Ingresar RFID
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-secondary rounded-pill" disabled>
                                Evaluar
                            </button>
                        }
                    </td>

                    <td class="text-center">

                        @{
                            bool todasConValor = item.Resultados.All(r => r.Valor != null);
                            bool todasAprobadas = item.Resultados.All(r => r.EsValido == true);
                        }

                        @* ✅ Si NO todas tienen valor → mostrar badges individuales *@
                        @if (!todasConValor)
                        {
                            <div class="d-flex flex-wrap justify-content-center gap-2 mb-2">
                                @foreach (var resultado in item.Resultados)
                                {
                                    <span class="badge
                                                        @(resultado.Valor == null
                                                                                      ? "bg-secondary"
                                                                                      : resultado.EsValido == true
                                                                                          ? "bg-success"
                                                                                          : "bg-danger")
                                        text-white rounded-pill">

                                        @resultado.Tolerancia.Prueba
                                    </span>
                                        }
                            </div>
                        }
                        else
                        {
                            @* ✅ Todas tienen valor → mostrar solo el estado general *@

                            @if (item.Estado != EstadoBatch.LlenadoAprobado)
                            {
                                <span class="badge bg-info text-white rounded-pill">
                                    Pendiente de Envío
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-success rounded-pill">
                                    Aprobado
                                </span>
                            }
                        }

                    </td>
                </tr>
            }
        }
    </tbody>
</table>