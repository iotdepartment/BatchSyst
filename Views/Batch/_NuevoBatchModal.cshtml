@model Batch.ViewModels.NuevoBatchModalViewModel

<div class="modal fade" id="nuevoBatchModal" tabindex="-1" aria-labelledby="nuevoBatchLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="nuevoBatchLabel">Nuevo Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">

                <!-- Botón Retrabajo -->
                <div class="row mb-3 d-flex justify-content-end">
                    <div class="col-3 text-end">
                        <button id="btnRetrabajo" class="btn btn-outline-danger w-100 p-2" onclick="seleccionarRetrabajo(this)">
                            Retrabajo
                        </button>
                    </div>
                </div>

                <!-- Componentes dinámicos -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h5 class="fw-bold">Componentes</h5>
                    </div>
                </div>
                <hr />
                <div class="row mb-3">
                    @foreach (var comp in Model.Componentes ?? Enumerable.Empty<SelectListItem>())
                    {
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-outline-primary btn-lg w-100 p-4"
                                    data-componente="@comp.Value"
                                    onclick="seleccionarComponente(this)">
                                @comp.Text
                            </button>
                        </div>
                    }
                </div>

                <!-- Líneas -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h5 class="fw-bold">Lineas</h5>
                    </div>
                </div>
                <hr>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <button class="btn btn-outline-info btn-lg w-100 p-4"
                                data-linea="1"
                                onclick="seleccionarLinea(this)">
                            Linea 1
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info btn-lg w-100 p-4"
                                data-linea="2"
                                onclick="seleccionarLinea(this)">
                            Linea 2
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info btn-lg w-100 p-4"
                                data-linea="3"
                                onclick="seleccionarLinea(this)">
                            Linea 3
                        </button>
                    </div>
                </div>

                <hr>

                <!-- Botón Guardar -->
                <div class="row mt-3">
                    <div class="col-md-12 text-center">
                        <button id="btnGuardarBatch" class="btn btn-success btn-lg px-5" disabled onclick="guardarBatch()">
                            Guardar Batch
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
           let componenteSeleccionado = null;
    let lineaSeleccionada = null;
    let retrabajoSeleccionado = false;

    function seleccionarComponente(button) {
        document.querySelectorAll("[data-componente]").forEach(b => b.classList.remove("active", "btn-selected"));
        button.classList.add("active", "btn-selected");
        componenteSeleccionado = button.getAttribute("data-componente");
        habilitarGuardar();
    }

    function seleccionarLinea(button) {
        document.querySelectorAll("[data-linea]").forEach(b => b.classList.remove("active", "btn-selected"));
        button.classList.add("active", "btn-selected");
        lineaSeleccionada = button.getAttribute("data-linea");
        habilitarGuardar();
    }

    function seleccionarRetrabajo(button) {
        retrabajoSeleccionado = !retrabajoSeleccionado;
        button.classList.toggle("active");
        button.classList.toggle("btn-selected");
    }

    function habilitarGuardar() {
        if (componenteSeleccionado && lineaSeleccionada) {
            document.getElementById("btnGuardarBatch").disabled = false;
        }
    }


            function guardarBatch() {
        fetch('/Batch/CrearBatch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                componenteId: componenteSeleccionado,
                linea: lineaSeleccionada,
                retrabajo: retrabajoSeleccionado
            })
        })
        .then(async response => {

            let data = null;

            try {
                data = await response.json();
            } catch {
                mostrarToast("Respuesta inválida del servidor", "danger");
                return;
            }

            if (!response.ok || data.success === false) {
                  console.error("ERROR FETCH:", err);

                mostrarToast(data.mensaje || "Error al crear el batch", "danger");
                return;
            }

            // ✅ ÉXITO REAL
            localStorage.setItem("toastSuccess", data.mensaje);

            const modalEl = document.getElementById('nuevoBatchModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.hide();

            location.reload();
        })
        .catch(err => {
            console.error(err);
            mostrarToast("Error de conexión al crear el batch", "danger");
        });
    }
</script>