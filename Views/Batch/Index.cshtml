@model IEnumerable<Batch.Models.Lote>
@using Batch.ViewModels
@{
    ViewData["Title"] = "Batches";
}

<div class="container mt-5">
    <!-- Botón para abrir modal -->
    <div class="row mb-4">
        <div class="col d-flex justify-content-start">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoBatchModal">
                Nuevo Batch
            </button>
        </div>
    </div>

    <h3 class="mb-3">Listado de Batches</h3>

    <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark text-center">
            <tr>
                <th>Folio</th>
                <th>Componente</th>
                <th>Turno</th>
                <th>Estado</th>
                <th>Fecha Finalizado</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <tr>
                        <td class="text-center">@item.Folio</td>
                        <td class="text-center">@(item.Componente?.Name ?? "Sin componente")</td>
                        <td class="text-center">
                            @Batch.Helpers.DiaLaboralHelper.ObtenerTurno(item.FechaInicio)
                        </td>
                        <td class="text-center">
                            @switch (item.Estado)
                            {
                                case EstadoBatch.PendienteDeLlenado:
                                    @:<span class="badge bg-secondary">Pendiente</span>
                                    break;
                                case EstadoBatch.LlenadoAprobado:
                                    @:<span class="badge bg-success">Aprobado</span>
                                    break;
                                case EstadoBatch.LlenadoRechazado:
                                    @:<span class="badge bg-danger">Rechazado</span>
                                    break;
                                case EstadoBatch.Consumido:
                                    @:<span class="badge bg-dark">Consumido</span>
                                    break;
                            }
                        </td>
                        <td class="text-center">
                            @if (item.Estado == EstadoBatch.PendienteDeLlenado)
                            {
                                <!-- Evaluar activo -->
                                <button class="btn btn-sm btn-info" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#batch-@item.Id">
                                    Evaluar
                                </button>
                            }
                            else if (item.Estado == EstadoBatch.LlenadoAprobado)
                            {
                                <!-- Botón para abrir modal de dato extra -->
                                <button class="btn btn-sm btn-primary" type="button"
                                        data-bs-toggle="modal" data-bs-target="#rfidModal-@item.Id">
                                    
                                    Ingresar RFID
                                </button>
                            }
                            else
                            {
                                <!-- Evaluar deshabilitado -->
                                <button class="btn btn-sm btn-secondary" type="button" disabled>
                                    Evaluar
                                </button>
                            }   
                        </td>

                </tr>

                    <tr class="collapse" id="batch-@item.Id">
                        <td colspan="9">
                            <div class="card card-body">
                                <h5 class="fw-bold mb-3">Pruebas del lote @item.Folio</h5>

                                <div class="row">
                                    <!-- Pruebas a la izquierda -->
                                    <div class="col-md-9">
                                        <div class="row g-3">
                                            @foreach (var resultado in item.Resultados)
                                            {
                                                <div class="col-md-4">
                                                    <!-- Label con nombre y estado -->
                                                    <label class="d-flex justify-content-between align-items-center rounded-pill px-3 py-2 bg-light fw-bold">
                                                        @resultado.Tolerancia.Prueba
                                                        <span id="estado-@resultado.Id">
                                                            @if (resultado.Valor.HasValue)
                                                            {
                                                            @Html.Raw(resultado.EsValido
                                                            ? "<span class='badge bg-success rounded-pill px-3'>OK</span>"
                                                            : "<span class='badge bg-danger rounded-pill px-3'>FAIL</span>")
                                                            }
                                                        </span>
                                                    </label>

                                                    <!-- Input redondeado -->
                                                    <input type="text"
                                                           id="valor-@resultado.Id"
                                                           value="@(resultado.Valor.HasValue? resultado.Valor.ToString() : "")"
                                                           class="form-control form-control-sm text-center rounded-pill mt-2"
                                                           readonly
                                                           @(item.Estado != EstadoBatch.PendienteDeLlenado ? "disabled" : "")
                                                           onclick="abrirPad(@resultado.Id, @resultado.Tolerancia.Min, @resultado.Tolerancia.Max)" />
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- Pad numérico fijo a la derecha -->
                                    <div class="col-md-3 h-100">
                                        <div id="numericPad-@item.Id" class="card p-3 h-100">
                                            <div class="row g-3 h-100">
                                                @for (int i = 1; i <= 9; i++)
                                                {
                                                    <div class="col-4 d-flex">
                                                        <button type="button"
                                                                class="btn btn-secondary btn-lg flex-fill"
                                                                style="height:80px;"
                                                                onclick="padInput(@item.Id,'@i')">
                                                            @i
                                                        </button>
                                                    </div>
                                                }
                                                <div class="col-4 d-flex">
                                                    <button type="button"
                                                            class="btn btn-danger btn-lg flex-fill"
                                                            style="height:80px;"
                                                            onclick="padDelete(@item.Id)">
                                                        ⌫
                                                    </button>
                                                </div>
                                                <div class="col-4 d-flex">
                                                    <button type="button"
                                                            class="btn btn-secondary btn-lg flex-fill"
                                                            style="height:80px;"
                                                            onclick="padInput(@item.Id,'0')">
                                                        0
                                                    </button>
                                                </div>
                                                <div class="col-4 d-flex">
                                                    <button type="button"
                                                            class="btn btn-secondary btn-lg flex-fill"
                                                            style="height:80px;"
                                                            onclick="padInput(@item.Id,'.')">
                                                        .
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Botón Guardar -->
                                    @if (item.Estado == EstadoBatch.PendienteDeLlenado)
                                    {
                                        <div class="text-center mt-4">
                                            <!-- Guardar solo persiste -->
                                            <button class="btn btn-warning px-5"
                                                    onclick="guardarResultados(@item.Id, false)">
                                                Guardar Datos
                                            </button>

                                            <!-- Enviar con confirmación -->
                                            <button class="btn btn-success px-5"
                                                    onclick="confirmarEnvio(@item.Id)">
                                                Enviar Datos
                                            </button>
                                        </div>
                                    }

                                </div>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="text-center text-muted">No hay batches registrados</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@foreach (var item in Model.Where(l => l.Estado == EstadoBatch.LlenadoAprobado))
{
    <div class="modal fade" id="rfidModal-@item.Id" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asignar RFID al lote @item.Folio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="rfidInput-@item.Id" class="form-control" placeholder="Ingrese RFID..." />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarRFID(@item.Id)">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}


<div class="modal fade" id="confirmarEnvioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Confirmar envío</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                ¿Seguro que deseas enviar este batch? Una vez enviado ya no podrás modificar los resultados.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarEnvio">Sí, enviar</button>
            </div>
        </div>
    </div>
</div>

<!-- Render del partial del modal -->
@await Html.PartialAsync("_NuevoBatchModal", (NuevoBatchModalViewModel)ViewBag.ModalVm)

@section Scripts {
    <script>
        let currentInput = null;
        let currentMin = 0;
        let currentMax = 0;
        let lotePendienteEnvio = null;

        function abrirPad(resultadoId, min, max) {
            currentInput = document.getElementById(`valor-${resultadoId}`);
            currentMin = min;
            currentMax = max;
        }

        function padInput(loteId, num) {
            if (currentInput) {
                currentInput.value += num;
                validar(currentInput, currentMin, currentMax);
            }
        }

        function padDelete(loteId) {
            if (currentInput) {
                currentInput.value = currentInput.value.slice(0, -1);
                validar(currentInput, currentMin, currentMax);
            }
        }

        function padConfirm(loteId) {
            currentInput = null;
        }

        function validar(input, min, max) {
            const valor = parseFloat(input.value);
            const estadoCell = document.getElementById(`estado-${input.id.replace("valor-", "")}`);
            if (!isNaN(valor)) {
                if (valor >= min && valor <= max) {
                    estadoCell.innerHTML = "<span class='badge bg-success rounded-pill px-3'>OK</span>";
                } else {
                    estadoCell.innerHTML = "<span class='badge bg-danger rounded-pill px-3'>FAIL</span>";
                }
            } else {
                estadoCell.innerHTML = "";
            }
        }

                function guardarResultados(loteId, enviar) {
            const inputs = document.querySelectorAll(`#batch-${loteId} input`);
            const resultados = [];
            inputs.forEach(i => {
                resultados.push({
                    ResultadoId: i.id.replace("valor-", ""),
                    Valor: i.value === "" ? null : parseFloat(i.value)
                });
            });

                    fetch('/Batch/GuardarResultados', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ loteId: loteId, resultados: resultados, enviar: enviar })
        })
            .then(r => {
                if (r.ok) location.reload();
                else alert("Error al guardar resultados");
            });
        }

        function confirmarEnvio(loteId) {
            lotePendienteEnvio = loteId;
            const modal = new bootstrap.Modal(document.getElementById('confirmarEnvioModal'));
            modal.show();
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("btnConfirmarEnvio").addEventListener("click", function () {
                if (lotePendienteEnvio) {
                    guardarResultados(lotePendienteEnvio, true);
                }
            });
        });
                function guardarRFID(loteId) {
            const valor = document.getElementById("rfidInput-" + loteId).value;

            fetch('/Batch/GuardarRFID', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ loteId: loteId, rfid: valor })
            })
            .then(r => {
                if (r.ok) {
                    location.reload(); // refresca para mostrar el RFID guardado
                } else {
                    alert("Error al guardar RFID");
                }
            });
        }

    </script>

    <script>
        function evaluarLocal(resultadoId, min, max) {
            const valor = parseFloat(document.getElementById(`valor-${resultadoId}`)?.value);
            if (isNaN(valor)) return;

            const estadoCell = document.getElementById(`estado-${resultadoId}`);
            if (valor >= min && valor <= max) {
                estadoCell.innerHTML = "<span class='badge bg-success'>OK</span>";
            } else {
                estadoCell.innerHTML = "<span class='badge bg-danger'>FAIL</span>";
            }
        }
    </script>
}