@using Batch.ViewModels
@model UsuariosViewModel

@{
    ViewData["Title"] = "Usuarios";
}

<div class="card p-4 shadow-sm">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">Usuarios del Sistema</h4>

        <button class="btn btn-primary rounded-pill px-4"
                onclick="abrirModalCrear()">
            + Nuevo Usuario
        </button>
    </div>

    <table id="tablaUsuarios" class="table table-striped table-bordered w-100">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in Model.Usuarios)
            {
                <tr>
                    <td>@u.Nombre</td>
                    <td>@u.UsuarioLogin</td>
                    <td>@u.RolNombre</td>
                    
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning rounded-pill px-3"
                                onclick="abrirModalEditar(@u.Id)">
                            Editar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- ✅ Contenedor donde se cargará el modal -->
<div id="modalContainer"></div>

@section Scripts {

    <!-- ✅ DataTable -->
    <script>
        $(document).ready(function () {
            $('#tablaUsuarios').DataTable({
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-MX.json"
                },
                pageLength: 10,
                responsive: true
            });
        });
    </script>

    <!-- ✅ Abrir modal para CREAR -->
    <script>
        function abrirModalCrear() {
            fetch('/Usuario/ModalCrear')
                .then(r => r.text())
                .then(html => {
                    document.getElementById("modalContainer").innerHTML = html;
                    new bootstrap.Modal(document.getElementById("usuarioModal")).show();
                });
        }
    </script>

    <!-- ✅ Abrir modal para EDITAR -->
    <script>
        function abrirModalEditar(id) {
            fetch(`/Usuario/ModalEditar/${id}`)
                .then(r => r.text())
                .then(html => {
                    document.getElementById("modalContainer").innerHTML = html;
                    new bootstrap.Modal(document.getElementById("usuarioModal")).show();
                });
        }
    </script>

    <!-- ✅ Guardar usuario (crear o editar) -->
    <script>
        function guardarUsuario() {

            const data = {
                id: parseInt(document.getElementById("usuarioId").value),
                nombre: document.getElementById("nombre").value,
                usuarioLogin: document.getElementById("usuarioLogin").value,
                password: document.getElementById("password").value,
                rolId: parseInt(document.getElementById("rolId").value)
            };

            fetch('/Usuario/Guardar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(res => {

                if (res.success) {

                    localStorage.setItem("toastMessage", res.message);
                    localStorage.setItem("toastType", "success");

                    location.reload();
                    return;
                }

                mostrarToast(res.message || "Error al guardar usuario", "danger");
            })
            .catch(err => {
                console.error(err);
                mostrarToast("Error de red", "danger");
            });
        }
    </script>

    <!-- ✅ Mostrar toast después del reload -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const msg = localStorage.getItem("toastMessage");
            const type = localStorage.getItem("toastType");

            if (msg) {
                mostrarToast(msg, type || "info");

                localStorage.removeItem("toastMessage");
                localStorage.removeItem("toastType");
            }
        });
    </script>

}